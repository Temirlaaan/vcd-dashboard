# --- default.nginx.conf ---

# Резолвер Docker DNS для динамического upstream
resolver 127.0.0.11 ipv6=off valid=30s;

# WebSocket helper (нужен для корректного Connection заголовка)
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# Бэкенд по имени контейнера (или сервиса compose)
upstream vcd_backend {
    zone vcd_backend 64k;
    server vcd-backend:8000 resolve;   # если в compose сервис называется иначе — поменяй имя
    keepalive 16;
}

# HTTP -> HTTPS редирект (и окно для ACME, если используешь webroot)
server {
    listen 80;
    server_name vcd-public-ips.t-cloud.kz;

    # (опционально) для certbot webroot
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/acme;
        default_type "text/plain";
    }

    return 301 https://$host$request_uri;
}

# HTTPS reverse-proxy на бэкенд
server {
    listen 443 ssl http2;
    server_name vcd-public-ips.t-cloud.kz;

    # ПУТИ К СЕРТИФИКАТАМ: у тебя монтируется ./frontend/nginx/ssl -> /etc/nginx/ssl
    ssl_certificate     /etc/nginx/ssl/t-cloud-2025.crt;   # <- замени на своё имя файла
    ssl_certificate_key /etc/nginx/ssl/t-cloud-2025.key;     # <- замени на своё имя файла

    # Базовые SSL-настройки (минимум; можно усилить по желанию)
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:10m;
    ssl_prefer_server_ciphers on;

    # Весь трафик — на бэкенд
    location / {
        proxy_pass http://vcd_backend;

        proxy_http_version 1.1;

        # Прокси-заголовки
        proxy_set_header Host               $host;
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto  $scheme;
        proxy_set_header X-Forwarded-Host   $host;
        proxy_set_header X-Forwarded-Port   $server_port;

        # WebSocket
        proxy_set_header Upgrade            $http_upgrade;
        proxy_set_header Connection         $connection_upgrade;

        # Таймауты/буферы (под себя можешь подкрутить)
        proxy_connect_timeout 10s;
        proxy_send_timeout    120s;
        proxy_read_timeout    120s;
        proxy_buffering       off;

        # Чтоб не переписывал Location в ответах бэка
        proxy_redirect off;

        # Опционально, если гоняешь крупные payload'ы
        client_max_body_size 50m;
    }
}

